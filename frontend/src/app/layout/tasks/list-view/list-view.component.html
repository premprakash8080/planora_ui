<div class="page-container task-board task-board--sheet">
  <header class="task-board__header">
    <div>
      <h1>
        <!-- Project Name -->
        <span class="project-name">{{ currentProjectName }}</span>
      </h1>
    </div>

    <!-- <div class="task-board__actions">
      <mat-form-field appearance="outline" class="task-search">
        <mat-label>Search tasks</mat-label>
        <input matInput [formControl]="searchControl" placeholder="Search by name, assignee or status" />
        <button mat-icon-button matSuffix *ngIf="searchControl.value" (click)="searchControl.setValue('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <button mat-fab color="primary" class="add-task-button" matTooltip="Add task" (click)="addQuickTask()">
        <mat-icon>add</mat-icon>
      </button>
    </div> -->
  </header>

  <section class="task-sections">
    <div class="task-grid-header" *ngIf="sections.length">
      <div class="header-cell header-cell--name">Name</div>
      <div class="header-cell">Assignee</div>
      <div class="header-cell">Due Date</div>
      <div class="header-cell">Priority</div>
      <div class="header-cell">Status</div>
      <div class="header-cell header-cell--comments">Comments</div>
    </div>

    <!-- scroll start from here this hole section is scrollable -->
    <div class="task-list-scroll">
      <div class="task-section" *ngFor="let section of sections">
        <button
          class="section-header"
          type="button"
          (click)="toggleSection(section)"
        >
          <mat-icon class="chevron" [class.expanded]="section.expanded"
            >expand_more</mat-icon
          >
          <span class="section-title">{{ section.title }}</span>
          <span class="task-count">{{ section.tasks.length }} tasks</span>
        </button>

        <div class="section-body" *ngIf="section.expanded">
          <div
            class="task-grid-row"
            *ngFor="let task of section.tasks"
            (click)="openTaskDetail(section, task)"
            [class.task-grid-row--selected]="selectedTask?.id === task.id"
          >
            <div
              class="grid-cell grid-cell--name"
              (click)="$event.stopPropagation()"
            >
              <div class="grid-name-wrapper">
                <mat-checkbox
                  color="primary"
                  [checked]="task.completed"
                  (change)="toggleCompleted(section, task)"
                  (click)="$event.stopPropagation()"
                ></mat-checkbox>
                <input
                  class="task-grid-name"
                  [ngModel]="nameDrafts.get(task.id) ?? task.name"
                  (ngModelChange)="onNameInput(task, $event)"
                  [style.width.px]="getTaskNameWidth(task)"
                  (focus)="handleNameFocus(task)"
                  (blur)="handleNameBlur(section, task, $any($event.target))"
                  (keydown.enter)="
                    handleNameEnter($event, section, task, $any($event.target))
                  "
                  (keydown.escape)="handleNameEscape(task, $any($event.target))"
                />
              </div>
            </div>

            <div
              class="grid-cell grid-cell--assignee"
              (click)="$event.stopPropagation()"
            >
              <app-dropdown-popover
                [items]="assigneeItems"
                [selectedId]="task.assignee ?? null"
                [width]="520"
                [maxHeight]="320"
                [hasSearch]="true"
                (select)="handleAssigneeSelect(section, task, $event)"
              >
                <button
                  type="button"
                  class="assignee-trigger"
                  appDropdownTrigger
                >
                  <app-avatar
                    size="sm"
                    [src]="getAssigneeAvatar(task.assignee)"
                    [initials]="getAssigneeInitials(task.assignee)"
                    [color]="getAssigneeColor(task.assignee)"
                    [alt]="task.assignee || 'Unassigned'"
                  ></app-avatar>
                  <span class="assignee-name" [title]="task.assignee || 'Unassigned'">
                    {{ task.assignee || 'Unassigned' }}
                  </span>
                  <mat-icon class="assignee-expand">expand_more</mat-icon>
                </button>
              </app-dropdown-popover>
            </div>

            <div
              class="grid-cell grid-cell--due"
              (click)="$event.stopPropagation()"
            >
              <app-dropdown-popover
                #dueDatePopover="appDropdownPopover"
                [width]="360"
                [maxHeight]="400"
              >
                <button
                  type="button"
                  class="due-date-trigger"
                  appDropdownTrigger
                >
                  <mat-icon>calendar_today</mat-icon>
                  <span>{{ formatDueDate(task.dueDate) }}</span>
                  <mat-icon>expand_more</mat-icon>
                </button>

                <ng-template appDropdownContent>
                  <app-calendar
                    [selected]="getDueDate(task)"
                    (dateChange)="handleDueDateChange(section, task, $event, dueDatePopover)"
                    (cancel)="dueDatePopover.close()"
                  ></app-calendar>
                </ng-template>
              </app-dropdown-popover>
            </div>

            <div class="grid-cell grid-cell--priority">
              <app-dropdown-popover
                [items]="priorityItems"
                [selectedId]="task.priority"
                [width]="240"
                (select)="handlePrioritySelect(section, task, $event)"
              >
                <button
                  type="button"
                  class="priority-trigger"
                  appDropdownTrigger
                >
                  <span
                    class="priority-pill"
                    [ngClass]="task.priority.toLowerCase()"
                  >
                    {{ task.priority }}
                  </span>
                  <mat-icon class="priority-expand">expand_more</mat-icon>
                </button>
              </app-dropdown-popover>
            </div>

            <div
              class="grid-cell grid-cell--status"
              (click)="$event.stopPropagation()"
            >
              <app-dropdown-popover
                [items]="statusItems"
                [selectedId]="task.status"
                [width]="260"
                (select)="handleStatusSelect(section, task, $event)"
              >
                <button type="button" class="status-trigger" appDropdownTrigger>
                  <span
                    class="status-dot"
                    [style.backgroundColor]="getStatusColor(task.status)"
                  ></span>
                  {{ getStatusLabel(task.status) }}
                  <mat-icon>expand_more</mat-icon>
                </button>
              </app-dropdown-popover>
            </div>

            <div class="grid-cell grid-cell--comments">
              <mat-icon>chat_bubble_outline</mat-icon>
              <span>{{
                task.comments?.length ?? task.commentsCount ?? 0
              }}</span>
            </div>
          </div>

          <button class="add-task" type="button" (click)="addTask(section)">
            <mat-icon>add</mat-icon>
            Add taskâ€¦
          </button>
        </div>
      </div>
    </div>
    <!-- scroll end here this hole section is scrollable -->
  </section>
</div>

<div
  class="task-detail-backdrop"
  *ngIf="selectedTask"
  (click)="closeDetail()"
></div>

<app-task-detail
  *ngIf="selectedTask"
  [open]="!!selectedTask"
  [task]="selectedTask"
  [projectName]="currentProjectName"
  [sectionTitle]="selectedSection?.title ?? ''"
  [statuses]="statuses"
  [priorities]="priorities"
  (close)="closeDetail()"
  (taskUpdated)="handleTaskUpdated($event)"
></app-task-detail>
