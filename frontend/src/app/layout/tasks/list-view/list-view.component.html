<div class="page-container task-board">
  <header class="task-board__header">
    <div>
      <h1>
        <mat-icon color="primary">view_list</mat-icon>
        Project Tasks
      </h1>
      <p>Track and manage work across your team with an Asana-inspired board.</p>
    </div>

    <div class="task-board__actions">
      <mat-form-field appearance="outline" class="task-search">
        <mat-label>Search tasks</mat-label>
        <input matInput [formControl]="searchControl" placeholder="Search by name, assignee or status" />
        <button mat-icon-button matSuffix *ngIf="searchControl.value" (click)="searchControl.setValue('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <button mat-fab color="primary" class="add-task-button" matTooltip="Add task" (click)="addQuickTask()">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </header>

  <section class="task-sections">
    <div class="task-section" *ngFor="let section of sections">
      <button class="section-header" type="button" (click)="toggleSection(section)">
        <mat-icon class="chevron" [class.expanded]="section.expanded">expand_more</mat-icon>
        <span class="section-title">{{ section.title }}</span>
        <span class="task-count">{{ section.tasks.length }} tasks</span>
      </button>

      <div class="section-body" *ngIf="section.expanded">
        <div
          class="task-row"
          *ngFor="let task of section.tasks"
          (click)="openTaskDetail(section, task)"
          [class.task-row--selected]="selectedTask?.id === task.id"
        >
          <div class="cell checkbox" (click)="$event.stopPropagation()">
            <mat-checkbox
              color="primary"
              [checked]="task.completed"
              (change)="toggleCompleted(section, task)"
              (click)="$event.stopPropagation()"
            ></mat-checkbox>
          </div>

          <div class="cell name" (click)="$event.stopPropagation()">
            <input
              class="task-name-input"
              [ngModel]="nameDrafts.get(task.id) ?? task.name"
              (ngModelChange)="onNameInput(task, $event)"
              [style.width.px]="getTaskNameWidth(task)"
              (focus)="handleNameFocus(task)"
              (blur)="handleNameBlur(section, task, $any($event.target))"
              (keydown.enter)="handleNameEnter($event, section, task, $any($event.target))"
              (keydown.escape)="handleNameEscape(task, $any($event.target))"
            />
          </div>

          <div class="cell assignee">
            <button
              mat-stroked-button
              type="button"
              class="assignee-trigger"
              [matMenuTriggerFor]="assigneeMenu"
              (click)="$event.stopPropagation()"
            >
              <div class="avatar">{{ getAvatarInitials(task.assignee) }}</div>
              <span class="assignee-name">{{ task.assignee }}</span>
              <mat-icon>expand_more</mat-icon>
            </button>
            <mat-menu #assigneeMenu="matMenu" (click)="$event.stopPropagation()">
              <button
                mat-menu-item
                *ngFor="let member of teamMembers"
                (click)="selectAssignee(section, task, member, $event)"
              >
                <div class="avatar avatar--menu">{{ member.initials }}</div>
                <span>{{ member.name }}</span>
              </button>
            </mat-menu>
          </div>

          <div class="cell due-date" (click)="$event.stopPropagation()">
            <button
              mat-stroked-button
              type="button"
              [matMenuTriggerFor]="dueDateMenu"
              #dueDateTrigger="matMenuTrigger"
              class="due-date-trigger"
            >
              <mat-icon>calendar_today</mat-icon>
              <span>{{ formatDueDate(task.dueDate) }}</span>
              <mat-icon>expand_more</mat-icon>
            </button>
            <mat-menu #dueDateMenu="matMenu" (click)="$event.stopPropagation()" class="due-date-menu">
              <mat-calendar
                [selected]="getDueDate(task)"
                (selectedChange)="handleDueDateChange(section, task, $event, dueDateTrigger)"
              ></mat-calendar>
            </mat-menu>
          </div>

          <div class="cell priority">
            <mat-chip [ngClass]="task.priority.toLowerCase()">{{ task.priority }}</mat-chip>
          </div>

          <div class="cell status">
            <button
              type="button"
              mat-stroked-button
              class="status-trigger"
              [matMenuTriggerFor]="statusMenu"
              (click)="$event.stopPropagation()"
            >
              <span class="status-dot" [style.backgroundColor]="getStatusColor(task.status)"></span>
              {{ getStatusLabel(task.status) }}
              <mat-icon>expand_more</mat-icon>
            </button>
            <mat-menu #statusMenu="matMenu" (click)="$event.stopPropagation()">
              <button
                mat-menu-item
                *ngFor="let option of statusOptions"
                (click)="selectStatus(section, task, option, $event)"
              >
                <span class="status-dot" [style.backgroundColor]="option.color"></span>
                <span>{{ option.label }}</span>
              </button>
            </mat-menu>
          </div>

          <div class="cell comments">
            <mat-icon>chat_bubble_outline</mat-icon>
            <span>{{ task.comments?.length ?? task.commentsCount ?? 0 }}</span>
          </div>
        </div>

        <button class="add-task" type="button" (click)="addTask(section)">
          <mat-icon>add</mat-icon>
          Add taskâ€¦
        </button>
      </div>
    </div>
  </section>
</div>

<div
  class="task-detail-backdrop"
  *ngIf="selectedTask"
  (click)="closeDetail()"
></div>

<app-task-detail
  *ngIf="selectedTask"
  [open]="!!selectedTask"
  [task]="selectedTask"
  [projectName]="currentProjectName"
  [sectionTitle]="selectedSection?.title ?? ''"
  [statuses]="statuses"
  [priorities]="priorities"
  (close)="closeDetail()"
  (taskUpdated)="handleTaskUpdated($event)"
></app-task-detail>

