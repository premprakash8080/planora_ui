<div class="page-container task-board">
  <header class="task-board__header">
    <div>
      <h1>
        <mat-icon color="primary">view_list</mat-icon>
        Project Tasks
      </h1>
      <p>Track and manage work across your team with an Asana-inspired board.</p>
    </div>

    <div class="task-board__actions">
      <mat-form-field appearance="outline" class="task-search">
        <mat-label>Search tasks</mat-label>
        <input matInput [formControl]="searchControl" placeholder="Search by name, assignee or status" />
        <button mat-icon-button matSuffix *ngIf="searchControl.value" (click)="searchControl.setValue('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <button mat-fab color="primary" class="add-task-button" matTooltip="Add task" (click)="addQuickTask()">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </header>

  <section class="task-sections">
    <div class="task-section" *ngFor="let section of sections">
      <button class="section-header" type="button" (click)="toggleSection(section)">
        <mat-icon class="chevron" [class.expanded]="section.expanded">expand_more</mat-icon>
        <span class="section-title">{{ section.title }}</span>
        <span class="task-count">{{ section.tasks.length }} tasks</span>
      </button>

      <div class="section-body" *ngIf="section.expanded">
        <div
          class="task-row"
          *ngFor="let task of section.tasks"
          (click)="openTaskDetail(section, task)"
          [class.task-row--selected]="selectedTask?.id === task.id"
        >
          <div class="cell checkbox" (click)="$event.stopPropagation()">
            <mat-checkbox
              color="primary"
              [checked]="task.completed"
              (change)="toggleCompleted(section, task)"
              (click)="$event.stopPropagation()"
            ></mat-checkbox>
          </div>

          <div class="cell name" (click)="$event.stopPropagation()">
            <input
              class="task-name-input"
              [ngModel]="nameDrafts.get(task.id) ?? task.name"
              (ngModelChange)="onNameInput(task, $event)"
              [style.width.px]="getTaskNameWidth(task)"
              (focus)="handleNameFocus(task)"
              (blur)="handleNameBlur(section, task, $any($event.target))"
              (keydown.enter)="handleNameEnter($event, section, task, $any($event.target))"
              (keydown.escape)="handleNameEscape(task, $any($event.target))"
            />
          </div>

          <div class="cell assignee">
            <div class="avatar">{{ task.assignee.charAt(0) }}</div>
            <span>{{ task.assignee }}</span>
          </div>

          <div class="cell due-date">
            <mat-icon>calendar_today</mat-icon>
            <span>{{ task.dueDate | date: 'MMM d, yyyy' }}</span>
          </div>

          <div class="cell priority">
            <mat-chip [ngClass]="task.priority.toLowerCase()">{{ task.priority }}</mat-chip>
          </div>

          <div class="cell status">
            <mat-menu #statusMenu="matMenu">
              <button mat-menu-item *ngFor="let status of statuses" (click)="statusChanged(section, task, status)">
                {{ status }}
              </button>
            </mat-menu>
            <button mat-button [matMenuTriggerFor]="statusMenu" class="status-trigger" (click)="$event.stopPropagation()">
              {{ task.status }}
              <mat-icon>expand_more</mat-icon>
            </button>
          </div>

          <div class="cell comments">
            <mat-icon>chat_bubble_outline</mat-icon>
            <span>{{ task.comments?.length ?? task.commentsCount ?? 0 }}</span>
          </div>
        </div>

        <button class="add-task" type="button" (click)="addTask(section)">
          <mat-icon>add</mat-icon>
          Add taskâ€¦
        </button>
      </div>
    </div>
  </section>
</div>

<div
  class="task-detail-backdrop"
  *ngIf="selectedTask"
  (click)="closeDetail()"
></div>

<app-task-detail
  *ngIf="selectedTask"
  [open]="!!selectedTask"
  [task]="selectedTask"
  [projectName]="currentProjectName"
  [sectionTitle]="selectedSection?.title ?? ''"
  [statuses]="statuses"
  [priorities]="priorities"
  (close)="closeDetail()"
  (taskUpdated)="handleTaskUpdated($event)"
></app-task-detail>

